<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Datasport Results Analyzer</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div class="container">
      <header>
        <h1>üèÉ Datasport Results Analyzer</h1>
        <p>Analyze and visualize race results from datasport.pl</p>
      </header>

      <main>
        <section class="input-section">
          <div class="input-group">
            <label for="datasport-url"
              >Enter
              <a
                href="https://wyniki.datasport.pl/"
                target="_blank"
                rel="noopener"
                >datasport.pl results</a
              >
              URL:</label
            >
            <input
              type="url"
              id="datasport-url"
              placeholder="https://wyniki.datasport.pl/results123456/..."
              aria-label="Datasport URL input"
            />
            <button id="prepare-download-btn" type="button">
              Prepare Download
            </button>
          </div>
          <div
            id="error-message"
            class="error-message"
            role="alert"
            aria-live="polite"
          ></div>

          <div
            id="manual-download-section"
            class="manual-section"
            style="display: none"
          >
            <h3>üì• Manual Download Required</h3>
            <p class="info-text">
              Due to CORS restrictions, please download the results file
              manually:
            </p>
            <ol class="instructions">
              <li>
                Click the button below to open the results.json file in a new
                tab
              </li>
              <li>
                Save the file (usually Ctrl/Cmd + S or right-click ‚Üí Save)
              </li>
              <li>Upload the saved file using the area below</li>
            </ol>
            <button
              id="open-json-btn"
              type="button"
              class="primary-btn"
              disabled
            >
              üìÑ Open results.json in New Tab
            </button>
          </div>

          <div id="upload-section" class="upload-section">
            <div id="drop-zone" class="drop-zone">
              <div class="drop-zone-content">
                <svg
                  class="upload-icon"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                  <polyline points="17 8 12 3 7 8"></polyline>
                  <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
                <p class="drop-text">Drag & drop results.json here</p>
                <p class="drop-text-or">or</p>
                <button type="button" id="browse-btn" class="secondary-btn">
                  Browse Files
                </button>
                <input
                  type="file"
                  id="file-input"
                  accept=".json,application/json"
                  style="display: none"
                />
              </div>
            </div>
            <div id="file-info" class="file-info" style="display: none"></div>
          </div>
        </section>

        <section id="stored-results-section" class="stored-results-section">
          <div class="section-header">
            <h2>üíæ Stored Results</h2>
            <div class="header-actions">
              <span id="storage-usage"></span>
              <button
                id="clear-all-btn"
                type="button"
                class="danger-btn-small"
                style="display: none"
              >
                Clear All
              </button>
            </div>
          </div>
          <div id="stored-results-list" class="stored-results-list">
            <p class="empty-message">
              No stored results yet. Upload a file to get started.
            </p>
          </div>
          <div class="storage-info-footer">
            <small
              >Note: IndexedDB uses compression and optimization. Individual
              file sizes may not sum to total usage.</small
            >
          </div>
        </section>

        <div id="data-info" class="data-info" style="display: none"></div>

        <div id="filters-section" class="filters-section" style="display: none">
          <div
            id="filters-header"
            class="filters-header"
            role="button"
            tabindex="0"
            aria-expanded="true"
          >
            <span class="collapse-icon">‚ñº</span>
            <span id="filters-header-text" class="header-text">Settings</span>
          </div>
          <div id="filters-content" class="filters-content">
            <div class="filter-group">
              <label for="distance-select">Select Distance:</label>
              <select id="distance-select" aria-label="Distance filter">
                <option value="">All Distances</option>
              </select>
              <span id="distance-info" class="distance-info"></span>
            </div>
            <div class="filter-group">
              <label for="bucket-size-select">Histogram Bucket Size:</label>
              <select id="bucket-size-select" aria-label="Bucket size filter">
                <option value="15">15 seconds</option>
                <option value="30">30 seconds</option>
                <option value="60" selected>60 seconds</option>
                <option value="120">120 seconds</option>
              </select>
            </div>
          </div>
        </div>

        <section
          id="results-section"
          class="results-section"
          style="display: none"
        >
          <h2>Race Results Visualizations</h2>

          <div class="visualization">
            <h3>Net Finish Times</h3>
            <p class="description">Each dot represents a finisher's net time</p>
            <div id="viz-netto-times" class="svg-container"></div>
            <button class="download-btn" data-viz="netto-times">
              Download SVG
            </button>
          </div>

          <div class="visualization">
            <h3>Histogram of Net Finish Times</h3>
            <p class="description">
              Distribution of finishers in 1-minute buckets
            </p>
            <div id="viz-histogram" class="svg-container"></div>
            <button class="download-btn" data-viz="histogram">
              Download SVG
            </button>
          </div>

          <div class="visualization">
            <h3>Start Time vs Finish Time</h3>
            <p class="description">
              Stacked histogram showing finish times segmented by start time
            </p>
            <div id="viz-start-buckets" class="svg-container"></div>
            <button class="download-btn" data-viz="start-buckets">
              Download SVG
            </button>
          </div>
        </section>
      </main>

      <footer>
        <p>
          Created by Adam Bukowski. Source code available on
          <a
            href="https://github.com/bukowskiadam/datasport-results-analyzer"
            target="_blank"
            rel="noopener"
            >GitHub</a
          >.
        </p>
      </footer>
    </div>

    <script type="module" src="app.js"></script>
  </body>
</html>
